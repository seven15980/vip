# 会员系统后端开发说明文档

## 一、项目结构要求

后端根目录为 `output/`，建议采用如下分层结构：

```
output/
  ├── main.py                # FastAPI入口
  ├── core/                  # 核心工具/配置（JWT、加密、依赖注入等）
  ├── models/                # SQLAlchemy ORM模型
  ├── schemas/               # Pydantic数据校验与序列化
  ├── crud/                  # 业务数据操作（每个表一个文件，单一职责）
  ├── api/                   # 路由与接口实现（按功能模块拆分）
  ├── deps/                  # 依赖注入（如获取当前用户、权限校验等）
  ├── utils/                 # 通用工具函数
  ├── database.py            # 数据库连接与会话管理
  ├── config.py              # 配置文件
  └── requirements.txt       # 依赖库
```

---

## 二、技术栈与依赖

- Python 3.9+
- FastAPI
- SQLAlchemy
- Pydantic
- bcrypt
- python-jose
- Uvicorn
- 其他：typing、alembic（可选）

**requirements.txt 示例：**
```
fastapi
uvicorn
sqlalchemy
pydantic
bcrypt
python-jose
```

---

## 三、数据库模型（models）

请严格按照《数据库设计最佳实践版.md》建表结构，使用 SQLAlchemy 定义 ORM 模型。  
每个表一个类，字段、外键、索引、默认值等需与设计一致。  
建议每个模型单独一个文件，便于维护和扩展。

---

## 四、Pydantic Schemas（schemas）

- 每个接口的请求体、响应体都需定义对应的 Pydantic 模型。
- 字段类型、必填/选填、示例、校验规则需与 openapi.yaml 保持一致。
- 响应体建议统一封装（如 code/msg/data）。

---

## 五、数据操作层（crud）

- 每个表/功能模块单独一个 crud 文件，封装所有数据库操作。
- 只做数据操作，不包含业务逻辑。
- 所有方法应有类型注解，便于类型检查和自动补全。
- 便于单元测试和复用，符合单一职责原则。

---

## 六、依赖注入（deps）

- 统一管理依赖注入，如获取当前用户、管理员校验、数据库会话等。
- 权限校验、token解析等逻辑应解耦到 deps 层。

---

## 七、核心工具（core）

- JWT 生成与校验
- 密码加密与校验
- 配置加载
- 统一异常处理

---

## 八、接口实现（api）

- 按功能模块拆分（如 user.py、membership.py、card_code.py、admin.py、notification.py）
- 每个接口严格按 openapi.yaml 实现，参数、响应、认证方式一致。
- 只做业务编排，不直接操作数据库，所有数据操作通过 crud 层完成。
- 业务逻辑清晰，异常捕获规范，响应格式统一。

---

## 九、工具函数（utils）

- 如卡密生成、分页工具、时间处理等通用函数。

---

## 十、入口文件（main.py）

- FastAPI 实例化
- 路由注册
- 中间件、异常处理、CORS等配置
- 启动命令示例

---

## 十一、统一响应与异常处理

- 所有接口返回统一格式：
  ```json
  {
    "code": 0,
    "msg": "success",
    "data": {...}
  }
  ```
- 失败时 code 非0，msg为错误信息。
- 统一异常处理器，捕获常见异常并返回规范响应。

---

## 十二、SOLID 原则要求

- **单一职责**：每个模块/类/函数只做一件事。
- **开放封闭**：对扩展开放，对修改封闭（如通过依赖注入、抽象基类等）。
- **里氏替换**：接口/基类可被子类替换，保证多态性。
- **接口隔离**：接口精细化，避免臃肿。
- **依赖反转**：高层模块不依赖底层模块，依赖抽象（如通过依赖注入实现）。

---

## 十三、开发流程建议

1. 先实现 models、schemas、database.py、config.py
2. 再实现 crud 层，保证所有数据操作可单元测试
3. 实现 core、utils、deps
4. 实现 api 层，编排业务逻辑
5. main.py 注册路由、配置中间件
6. 补充 requirements.txt、README.md
7. 可选：alembic 生成迁移脚本

---

## 十四、参考资料

- 数据库设计见《数据库设计最佳实践版.md》
- 接口规范见 openapi.yaml
- 业务流程见《实现具体功能逻辑.md》

---

## 十五、代码生成指令（可直接发给大模型）

> 请在 output 目录下，按上述结构和要求，基于以下资料（数据库设计、openapi.yaml、功能实现逻辑），用 FastAPI+SQLAlchemy+Pydantic+JWT+bcrypt 实现完整后端代码。要求代码分层清晰，符合 SOLID 原则，接口严格按 openapi.yaml 实现，响应格式统一，异常处理规范。请生成 models、schemas、crud、api、core、deps、utils、main.py、requirements.txt 等所有必要文件，并给出 main.py 入口。每个接口都要有详细注释和类型注解，便于维护和扩展。

---

**你只需将本说明文档和你的三份资料（数据库设计、openapi.yaml、功能实现逻辑）一起发给大模型，即可自动生成高质量、可维护、可扩展的后端代码！**  
如需某个模块的详细代码模板，也可随时补充说明。 