# 会员系统数据库设计（最佳实践版）

---

## 一、核心业务规则梳理

1. **通知**：有系统通知（全体用户可见）和私有通知（如会员容量到期提醒，仅特定用户可见）。
2. **卡密**：面值统一为365元，可用于本地会员/线上会员充值。线上会员每10G/年为365元，可叠加。
3. **会员**：分本地会员（local）和线上会员（online），线上会员可多次充值叠加存储空间和时长。
4. **管理员**：有后台管理需求。

---

## 二、数据库表结构设计

### 1. 用户表（user）

| 字段名         | 类型         | 说明           |
| -------------- | ------------ | -------------- |
| id             | INTEGER PK   | 用户ID         |
| email          | TEXT UNIQUE  | 邮箱           |
| password_hash  | TEXT         | 密码哈希       |
| is_active      | BOOLEAN      | 是否激活       |
| created_at     | DATETIME     | 注册时间       |
| updated_at     | DATETIME     | 更新时间       |

---

### 2. 会员表（membership）

| 字段名         | 类型         | 说明           |
| -------------- | ------------ | -------------- |
| id             | INTEGER PK   | 会员ID         |
| user_id        | INTEGER      | 用户ID（FK）   |
| type           | TEXT         | 会员类型(local/online) |
| expire_at      | DATETIME     | 到期时间       |
| storage_total  | INTEGER      | 总存储空间(GB，仅online) |
| created_at     | DATETIME     | 开通时间       |
| updated_at     | DATETIME     | 更新时间       |

> 说明：  
> - local会员：type=local，storage_total可为0或NULL。  
> - online会员：type=online，storage_total为总空间（10、20、30...GB），每充值365元增加10GB和一年时长，叠加。

---

### 3. 卡密表（card_code）

| 字段名         | 类型         | 说明           |
| -------------- | ------------ | -------------- |
| id             | INTEGER PK   | 主键           |
| code           | TEXT UNIQUE  | 卡密           |
| value          | INTEGER      | 面值（元，固定365）|
| type           | TEXT         | 卡密类型(local/online/both)|
| is_used        | BOOLEAN      | 是否已使用     |
| used_by        | INTEGER      | 使用者用户ID（未用为null）|
| used_at        | DATETIME     | 使用时间       |
| created_at     | DATETIME     | 生成时间       |

---

### 4. 卡密使用记录表（card_code_log）

| 字段名         | 类型         | 说明           |
| -------------- | ------------ | -------------- |
| id             | INTEGER PK   | 主键           |
| code           | TEXT         | 卡密           |
| user_id        | INTEGER      | 使用者用户ID   |
| used_at        | DATETIME     | 使用时间       |
| action         | TEXT         | 使用动作（如"充值本地会员一年"、"充值线上会员10G/年"、"增加10G存储"）|

---

### 5. 管理员表（admin）

| 字段名         | 类型         | 说明           |
| -------------- | ------------ | -------------- |
| id             | INTEGER PK   | 主键           |
| username       | TEXT UNIQUE  | 管理员账号     |
| password_hash  | TEXT         | 密码哈希       |
| created_at     | DATETIME     | 创建时间       |

---

### 6. 通知表（notification）

| 字段名         | 类型         | 说明           |
| -------------- | ------------ | -------------- |
| id             | INTEGER PK   | 主键           |
| title          | TEXT         | 标题           |
| content        | TEXT         | 内容           |
| type           | TEXT         | 通知类型（system/private）|
| created_at     | DATETIME     | 创建时间       |

---

### 7. 用户通知关联表（user_notification）

| 字段名         | 类型         | 说明           |
| -------------- | ------------ | -------------- |
| id             | INTEGER PK   | 主键           |
| user_id        | INTEGER      | 用户ID（FK）   |
| notification_id| INTEGER      | 通知ID（FK）   |
| is_read        | BOOLEAN      | 是否已读       |
| read_at        | DATETIME     | 已读时间       |

> 说明：  
> - 系统通知：插入notification后，批量插入user_notification（或用户访问时动态生成）。  
> - 私有通知：只插入特定user_id的user_notification。

---

## 三、业务逻辑说明

- 卡密充值时，根据用户选择充值本地会员或线上会员，分别更新 membership 表对应记录（本地会员延长一年，线上会员增加10G和一年时长，均可叠加）。
- 通知推送时，系统通知插入所有用户，私有通知只插入目标用户。
- 会员到期自动生成私有通知，提醒用户及时续费，否则到期后可触发清理逻辑。

---

## 四、SQL 建表语句示例

```sql
CREATE TABLE user (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  is_active BOOLEAN DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE membership (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  type TEXT NOT NULL, -- local/online
  expire_at DATETIME NOT NULL,
  storage_total INTEGER, -- 仅online会员有
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY(user_id) REFERENCES user(id)
);

CREATE TABLE card_code (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  code TEXT UNIQUE NOT NULL,
  value INTEGER NOT NULL, -- 365
  type TEXT NOT NULL, -- local/online/both
  is_used BOOLEAN DEFAULT 0,
  used_by INTEGER,
  used_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY(used_by) REFERENCES user(id)
);

CREATE TABLE card_code_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  code TEXT NOT NULL,
  user_id INTEGER NOT NULL,
  used_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  action TEXT,
  FOREIGN KEY(user_id) REFERENCES user(id)
);

CREATE TABLE admin (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE notification (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  type TEXT NOT NULL, -- system/private
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_notification (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  notification_id INTEGER NOT NULL,
  is_read BOOLEAN DEFAULT 0,
  read_at DATETIME,
  FOREIGN KEY(user_id) REFERENCES user(id),
  FOREIGN KEY(notification_id) REFERENCES notification(id)
);
```

---

如需 ORM（如SQLAlchemy、Prisma）模型代码或有其他字段需求，请随时告知！ 